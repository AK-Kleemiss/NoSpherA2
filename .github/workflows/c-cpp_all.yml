name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
    FEATOMIC_CMAKE_FLAGS: "-DCMAKE_BUILD_TYPE=Release -DFEATOMIC_FETCH_METATENSOR=ON -DBUILD_SHARED_LIBS=OFF"

jobs:
  # Build matrix for all platforms
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS universal binary build using CMake (builds both x86_64 and arm64 in one step)
          - os: macos-latest
            name: Mac_Universal
            build-script: |
              mkdir build && cd build 
              cmake .. -GNinja -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DCMAKE_BUILD_TYPE=Release 
              cmake --build . --target NoSpherA2 -j
            artifact-name: executable_MacOS_Universal
            artifact-path: build/Src/NoSpherA2

          - os: ubuntu-latest
            name: Linux
            build-script: | 
              export cc=gcc
              export c++=g++
              mkdir build && cd build
              cmake .. -GNinja -DONEAPI_DIRECTORY=./Lib/MKL -DCMAKE_BUILD_TYPE=Release
              cmake --build . --target NoSpherA2 -j"
            artifact-name: executable_Linux
            artifact-path: build/Src/NoSpherA2

          - os: windows-2022
            name: Windows
            build-script: |
              mkdir build
              cd build
              cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release ..
              cmake --build . --config Release --target NoSpherA2 --parallel
            artifact-name: executable_Windows
            artifact-path: build/Src/Release/NoSpherA2.exe

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.name }}

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Setup Build Environment
      uses: ./.github/actions/setup-build-env
      with:
        platform: ${{ matrix.name }}

    - name: Cache Dependencies
      uses: ./.github/actions/cache-deps
      with:
        platform: ${{ matrix.name }}

    - name: Build Dependencies
      uses: ./.github/actions/build-deps
      with:
        platform: ${{ matrix.name }}

    - name: Build NoSpherA2
      run: ${{ matrix.build-script }}

    - name: Upload Artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}

  # Separate testing job
  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Download Linux Executable
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        name: executable_Linux
        path: ./

    - name: Run Tests
      run: |
        # The artifact preserves directory structure, so we need to find the executable
        find . -name "NoSpherA2" -type f -exec chmod +x {} \;
        cp ./build/Src/NoSpherA2 ./NoSpherA2 || cp ./NoSpherA2 ./NoSpherA2 || true
        chmod +x NoSpherA2
        cd tests
        export LD_LIBRARY_PATH=../:$LD_LIBRARY_PATH
        make all -k

    - name: Upload Artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: differences in tests
        path: tests/*.diff

  # Combine all artifacts
  combine_all:
    needs: [build]
    runs-on: ubuntu-latest
    name: Combine All Executables

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
      with:
        egress-policy: audit

    - name: Download Linux Executable
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        name: executable_Linux
        path: linux

    - name: Download macOS Universal Binary
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        name: executable_MacOS_Universal
        path: macos

    - name: Download Windows Executable
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        name: executable_Windows
        path: windows

    - name: Organize executables
      run: |
        mkdir -p combined
        # Find and copy the executables
        find linux -name "NoSpherA2" -type f -exec cp {} combined/NoSpherA2_Linux \;
        find macos -name "NoSpherA2" -type f -exec cp {} combined/NoSpherA2_Mac \;
        find windows -name "NoSpherA2.exe" -type f -exec cp {} combined/NoSpherA2.exe \;
        ls -la combined/

    - name: Archive all executables
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: executables
        path: combined/

  # Security analysis jobs
  CodeQL:
    name: Analyze
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp' ]

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
      with:
        egress-policy: audit

    - name: Checkout repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Initialize CodeQL
      uses: github/codeql-action/init@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
      with:
        languages: ${{ matrix.language }}
        source-root: Src

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    # Cache IntelMKL
    - name: Cache IntelMKL Build
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      id: cache-intelmkl-linux
      with:
        path: Lib/MKL
        key: intelmkl-linux-${{ runner.os }}-${{ hashFiles('Lib/MKL/**') }}
        restore-keys: |
          intelmkl-linux-${{ runner.os }}-

    - name: Build IntelMKL
      if: steps.cache-intelmkl-linux.outputs.cache-hit != 'true'
      run: |
          wget https://registrationcenter-download.intel.com/akdlm/IRC_NAS/47c7d946-fca1-441a-b0df-b094e3f045ea/intel-onemkl-2025.2.0.629_offline.sh 
          sh intel-onemkl-2025.2.0.629_offline.sh -a -s --install-dir=/home/runner/work/NoSpherA2/NoSpherA2/Lib/MKL --eula accept

    # Cache featomic
    - name: Cache featomic Build
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      id: cache-featomic-linux
      with:
        path: Lib/featomic_install
        key: featomic-linux-${{ runner.os }}-${{ hashFiles('featomic/**,Lib/featomic_install/**') }}
        restore-keys: |
          featomic-linux-${{ runner.os }}-

    - name: Build featomic
      if: steps.cache-featomic-linux.outputs.cache-hit != 'true'
      run: |
          cd featomic/featomic 
          mkdir -p build
          cd build 
          cmake -DCMAKE_BUILD_TYPE=Release -DFEATOMIC_FETCH_METATENSOR=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=../../featomic_install .. 
          make install

    - name: Build project
      run: cd Linux && make -j1

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
      with:
        output: 'codeql-results.sarif'
      continue-on-error: true

    - name: Upload analysis results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
      with:
        sarif_file: ${{github.workspace}}/codeql-results.sarif
        category: codeql
      continue-on-error: true

  flawfinder:
    name: flawfinder
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
            submodules: false
            fetch-depth: 1

      - name: transfer to UTF8
        run: |
          find Src/. -type f -exec bash -c 'file="$1"; if [[ $(file -b --mime-encoding "$file") != "utf-8" ]]; then iconv -f ISO-8859-1 -t UTF-8 "$file" -o "${file}.utf8" && mv "${file}.utf8" "$file"; fi' _ {} \;

      - name: flawfinder_scan
        uses: david-a-wheeler/flawfinder@c57197cd6061453f10a496f30a732bc1905918d1 # 2.0.19
        with:
          arguments: '--sarif Src'
          output: 'flawfinder_results.sarif'
        continue-on-error: true

      - name: Upload analysis results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
        with:
          sarif_file: ${{github.workspace}}/flawfinder_results.sarif
          category: flawfinder
