name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
    FEATOMIC_CMAKE_FLAGS: "-DCMAKE_BUILD_TYPE=Release -DFEATOMIC_FETCH_METATENSOR=ON -DBUILD_SHARED_LIBS=OFF"
    SCCACHE_GHA_ENABLED: "true"
    RUSTC_WRAPPER: "sccache"
    OCC_DATA_PATH: "${{ github.workspace }}/build/occ_data"
    CPM_SOURCE_CACHE: "${{ github.workspace }}/cache/cpm"

jobs:
  # Build matrix for all platforms
  build:
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: macos-latest  # Apple Silicon (ARM64)
            name: Mac_ARM64
            build-script: | 
              mkdir -p build && cd build 
              cmake .. -GNinja -DCMAKE_OSX_ARCHITECTURES="arm64" -DIS_ACTIONS=ON -DCMAKE_BUILD_TYPE=Release -DOpenMP_ROOT=$(brew --prefix)/opt/libomp -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
              cmake --build . --target NoSpherA2 -j3
            artifact-name: executable_MacOS_ARM64
            artifact-path: build/NoSpherA2

          - os: macos-15-intel  # Intel x86_64
            name: Mac_x86_64
            build-script: |
              mkdir -p build && cd build 
              cmake .. -GNinja -DCMAKE_OSX_ARCHITECTURES="x86_64" -DIS_ACTIONS=ON -DCMAKE_BUILD_TYPE=Release -DOpenMP_ROOT=$(brew --prefix)/opt/libomp -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
              cmake --build . --target NoSpherA2 -j3
            artifact-name: executable_MacOS_x86_64
            artifact-path: build/NoSpherA2

          - os: ubuntu-latest
            name: Linux
            build-script: | 
              mkdir -p build && cd build
              cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release \
                               -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                               -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
                               -DBUILD_SHARED_LIBS=OFF \
                               -DTBB_BUILD_SHARED=OFF \
                               -DIS_ACTIONS=ON
              cmake --build . --target NoSpherA2 -j4
            artifact-name: executable_Linux
            artifact-path: |
              build/NoSpherA2
              build/libiomp5.so

          - os: windows-2022
            name: Windows
            build-script: |
              cmake -E make_directory build
              cd build
              cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release `
              -DCMAKE_C_COMPILER=clang-cl.exe `
              -DCMAKE_LINKER=lld-link `
              -DCMAKE_CXX_COMPILER=clang-cl.exe `
              -DCMAKE_C_COMPILER_LAUNCHER=sccache `
              -DCMAKE_CXX_COMPILER_LAUNCHER=sccache `
              -DCMAKE_EXE_LINKER_FLAGS="runtimeobject.lib" `
              -DCMAKE_SHARED_LINKER_FLAGS="runtimeobject.lib" `
              -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
              -DBUILD_SHARED_LIBS=OFF `
              -DTBB_BUILD_SHARED=OFF `
              -DIS_ACTIONS=ON
              cmake --build . --config Release --target NoSpherA2 -j4
            artifact-name: executable_Windows
            artifact-path: |
              build/NoSpherA2.exe
              build/libiomp5md.dll

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.name }}

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.13.3
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Setup Build Environment
      uses: ./.github/actions/setup-build-env
      with:
        platform: ${{ matrix.name }}

    - name: Cache action
      uses: ./.github/actions/cache-deps
      with:
        platform: ${{ matrix.name }}

    - name: Build Dependencies
      uses: ./.github/actions/build-deps
      with:
        platform: ${{ matrix.name }}

    - name: Build NoSpherA2
      run: ${{ matrix.build-script }}

    - name: Test ${{ matrix.name }}
      shell: bash
      working-directory: build
      run: |
        if [ "${{ matrix.os }}" = "windows-2022" ]; then
          ctest -C Release --output-on-failure -j 1
        else
          ctest --output-on-failure -j 1
        fi

#    - name: Setup tmate session
#      if: ${{ failure() }}
#      uses: mxschmitt/action-tmate@v3
#      with:
#        limit-access-to-actor: true
#
    - name: Upload Test Artifacts
      if: failure()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: test-logs-${{ matrix.name }}
        path: |
          build/tests/**/*.log
          build/tests/**/*.diff
          build/tests/**/*.good
          build/Testing/Temporary/LastTest.log

    - name: Upload Artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}

  # Create macOS Universal Binary
  build_mac_universal:
    needs: build
    runs-on: macos-latest
    name: Build macOS Universal Binary

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Download ARM64 Binary
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: executable_MacOS_ARM64
        path: ./arm64/

    - name: Download x86_64 Binary
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: executable_MacOS_x86_64
        path: ./x86_64/

    - name: Create Universal Binary with lipo
      run: |
        echo "Creating universal binary with lipo..."
        mkdir -p universal
        
        # Make binaries executable
        chmod +x ./arm64/NoSpherA2
        chmod +x ./x86_64/NoSpherA2
        
        # Verify architectures before combining
        echo "ARM64 binary architecture:"
        file ./arm64/NoSpherA2
        lipo -info ./arm64/NoSpherA2
        
        echo "x86_64 binary architecture:"
        file ./x86_64/NoSpherA2
        lipo -info ./x86_64/NoSpherA2
        
        # Create universal binary
        lipo -create -output ./universal/NoSpherA2_Mac ./arm64/NoSpherA2 ./x86_64/NoSpherA2
        
        # Verify universal binary
        echo "Universal binary architecture:"
        file ./universal/NoSpherA2_Mac
        lipo -info ./universal/NoSpherA2_Mac
        
        # Make executable
        chmod +x ./universal/NoSpherA2_Mac

    - name: Upload Universal Binary
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: executable_MacOS_Universal
        path: ./universal/NoSpherA2_Mac

  # Combine all artifacts
  combine_all:
    needs: [build, build_mac_universal]
    runs-on: ubuntu-latest
    name: Combine All Executables

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - name: Download Linux Executable
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: executable_Linux
        path: linux

    - name: Download macOS Universal Binary
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: executable_MacOS_Universal
        path: macos

    - name: Download Windows Executable
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: executable_Windows
        path: windows

    - name: Organize executables
      run: |
        mkdir -p combined
        # Find and copy the executables
        find linux -name "NoSpherA2" -type f -exec cp {} combined/NoSpherA2_Linux \;
        find macos -name "NoSpherA2" -type f -exec cp {} combined/NoSpherA2_Mac \;
        find windows -name "NoSpherA2.exe" -type f -exec cp {} combined/NoSpherA2.exe \;
        ls -la combined/

    - name: Archive all executables
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: executables
        path: combined/

  # Security analysis jobs
  CodeQL:
    name: Analyze
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp' ]

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Initialize CodeQL
      uses: github/codeql-action/init@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
      with:
        languages: ${{ matrix.language }}
        source-root: Src

    - name: Cache action
      uses: ./.github/actions/cache-deps
      with:
        platform: Linux

    - name: Setup Build Environment
      uses: ./.github/actions/setup-build-env
      with:
        platform: Linux

    - name: Build project
      run: |
        mkdir -p build && cd build
        cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release \
                         -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                         -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
                         -DBUILD_SHARED_LIBS=OFF \
                         -DTBB_BUILD_SHARED=OFF

        cmake --build . --target NoSpherA2 -j4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
      with:
        output: 'codeql-results.sarif'
      continue-on-error: true

    - name: Upload analysis results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
      with:
        sarif_file: ${{github.workspace}}/codeql-results.sarif
        category: codeql
      continue-on-error: true

  flawfinder:
    name: flawfinder
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
            submodules: false
            fetch-depth: 1

      - name: transfer to UTF8
        run: |
          find Src/. -type f -exec bash -c 'file="$1"; if [[ $(file -b --mime-encoding "$file") != "utf-8" ]]; then iconv -f ISO-8859-1 -t UTF-8 "$file" -o "${file}.utf8" && mv "${file}.utf8" "$file"; fi' _ {} \;

      - name: flawfinder_scan
        uses: david-a-wheeler/flawfinder@c57197cd6061453f10a496f30a732bc1905918d1 # 2.0.19
        with:
          arguments: '--sarif Src'
          output: 'flawfinder_results.sarif'
        continue-on-error: true

      - name: Upload analysis results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: ${{github.workspace}}/flawfinder_results.sarif
          category: flawfinder
