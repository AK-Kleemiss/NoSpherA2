name: BUILD_CMAKE
on:
  workflow_dispatch:


jobs:
  build_linux:
    runs-on: ubuntu-latest
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
      with:
        egress-policy: audit

    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Install Compiler
      run: sudo apt update && sudo apt install -y build-essential

    # Cache IntelMKL
    - name: Cache IntelMKL Build
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      id: cache-intelmkl-linux
      with:
        path: Lib/MKL
        key: intelmkl-linux-${{ runner.os }}-${{ hashFiles('Lib/MKL/**') }}
        restore-keys: |
          intelmkl-linux-${{ runner.os }}-

    - name: Build IntelMKL
      if: steps.cache-intelmkl-linux.outputs.cache-hit != 'true'
      run: |
          wget https://registrationcenter-download.intel.com/akdlm/IRC_NAS/47c7d946-fca1-441a-b0df-b094e3f045ea/intel-onemkl-2025.2.0.629_offline.sh 
          sh intel-onemkl-2025.2.0.629_offline.sh -a -s --install-dir=/home/runner/work/NoSpherA2/NoSpherA2/Lib/MKL --eula accept

    - name: Cache featomic Build
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      id: cache-featomic-linux
      with:
        path: build/_deps  # Adjust if featomic installs elsewhere
        key: featomic-linux-${{ runner.os }}-${{ hashFiles('build/_deps/metatensor-build/metatensor-core/target/release/libmetatensor.a', 'build/_deps/featomic-build/target/release/libfeatomic.a') }}
        restore-keys: |
          featomic-linux-${{ runner.os }}-

    - name: Build featomic
      if: steps.cache-featomic-linux.outputs.cache-hit != 'true'
      run: |
        mkdir -p build
        cd build 
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
        cmake --build . --target featomic_target

    - name: Build NoSpherA2
      run: |
        cd build
        cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
        ninja -j0

  build_windows:
    runs-on:  windows-2022
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
    - uses: friendlyanon/setup-vcpkg@v1.6.1
      with: { committish: 4334d8b4c8916018600212ab4dd4bbdc343065d1 }
    - name: Setup Windows
      shell: powershell
      run: |
        # Install Rust and Cargo for Windows
        Write-Host "Installing Rust toolchain"
        
        # Download and install rustup
        Invoke-WebRequest -Uri "https://win.rustup.rs/x86_64" -OutFile "rustup-init.exe"
        .\rustup-init.exe -y
        
        # Add cargo to PATH for this session
        $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
        
        # Set default toolchain
        & "$env:USERPROFILE\.cargo\bin\rustup.exe"
        & "$env:USERPROFILE\.cargo\bin\rustup.exe" component add rust-src
        
        # Verify versions
        Write-Host "Rust version: $(& "$env:USERPROFILE\.cargo\bin\rustc.exe" --version)"
        Write-Host "Cargo version: $(& "$env:USERPROFILE\.cargo\bin\cargo.exe" --version)"
        
        # Update PATH for subsequent steps
        echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
#        & "$env:VCPKG_ROOT/vcpkg.exe" install intel-mkl --vcpkg-root ${{ env.VCPKG_ROOT }}

    - name: Setup MSBuild (Windows)
      uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce # v2.0.0

    - name: Setup Cargo environment (Windows)
      shell: powershell
      run: |
        # Ensure cargo is in PATH
        $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
        
        # Verify we have the right version
        & "$env:USERPROFILE\.cargo\bin\cargo.exe" --version
        & "$env:USERPROFILE\.cargo\bin\rustc.exe" --version

    - name: Build NoSpherA2
      shell: powershell
      run: |
        cd ${{ github.workspace }}
        mkdir build
        cd build
        cmake -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE=Release -D "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" ..
        cmake --build . --config Release --parallel 

    - name: Upload Universal Binary
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: windowsExec
        path: |
              build/Src/Release/NoSpherA2.exe
              build/NoSpherA2.sln
